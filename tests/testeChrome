# Use the AlmaLinux 9 base image
FROM almalinux:9

# Set build arguments for flexibility and security
ARG VNC_PASSWORD=YourSecurePasswordHere

# Install EPEL repository
RUN dnf install -y epel-release && \
    dnf clean all

# Configure EPEL to use the official Fedora Project mirror for reliability
RUN sed -i 's|^metalink=|#metalink=|g' /etc/yum.repos.d/epel.repo && \
    sed -i 's|^#baseurl=|baseurl=|g' /etc/yum.repos.d/epel.repo && \
    sed -i 's|^baseurl=.*|baseurl=https://dl.fedoraproject.org/pub/epel/$releasever/Everything/$basearch/|g' /etc/yum.repos.d/epel.repo

# Clean all caches and rebuild the metadata cache
RUN dnf clean all && \
    dnf makecache

# Install 'zvbi' and 'zimg' separately with increased verbosity to monitor installation
RUN dnf -v install -y zvbi || { echo "Failed to install zvbi"; exit 1; }
RUN dnf -v install -y zimg || { echo "Failed to install zimg"; exit 1; }

# Install necessary packages with '--nobest' to allow older versions if needed
RUN dnf install -y \
    yum-utils \
    --setopt=install_weak_deps=False \
    --exclude=*.i686 && \
    dnf config-manager --set-enabled crb && \
    dnf install -y \
        xorg-x11-server-Xorg \
        xorg-x11-xauth \
        xorg-x11-xinit \
        xterm \
        openbox \
        tigervnc-server \
        dbus-x11 \
        chromium \
        gtk3 \
        libX11 \
        alsa-lib \
        nss \
        atk \
        libXtst \
        libXScrnSaver \
        libXcomposite \
        libXdamage \
        libXcursor \
        libXi \
        libXrandr \
        libXrender \
        pango \
        alsa-plugins-pulseaudio \
        cups-libs \
        util-linux \
        --nobest && \
    dnf clean all && \
    rm -rf /var/cache/dnf

# Set up the VNC server configuration
RUN mkdir -p /root/.vnc

# Set VNC password using build argument for security
RUN echo "${VNC_PASSWORD}" | vncpasswd -f > /root/.vnc/passwd && \
    chmod 600 /root/.vnc/passwd

# Copy the startup script into the image
COPY startup_chromium.sh /root/startup.sh

# Make the startup script executable
RUN chmod +x /root/startup.sh

# Expose the VNC port
EXPOSE 5901

# Set the default command to run the startup script
CMD ["/root/startup.sh"]
