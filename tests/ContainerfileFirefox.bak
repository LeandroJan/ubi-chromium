# Use the AlmaLinux 9 base image
FROM almalinux:9

# Install necessary packages
RUN yum update -y && \
    yum install -y \
        epel-release && \
    yum install -y yum-utils && \
    yum config-manager --set-enabled crb && \
    yum install -y \
        xorg-x11-server-Xorg \
        xorg-x11-xauth \
        xorg-x11-xinit \
        xterm \
        openbox \
        tigervnc-server \
        dbus-x11 \
        firefox \
        gtk3 \
        libX11 \
        alsa-lib \
        nss \
        atk \
        libXtst \
        libXScrnSaver \
        libXcomposite \
        libXdamage \
        libXcursor \
        libXi \
        libXrandr \
        libXrender \
        pango \
        alsa-plugins-pulseaudio \
        cups-libs \
        --setopt=install_weak_deps=False \
        --exclude=*.i686 && \
    yum clean all

# Set up the VNC server configuration
RUN mkdir -p /root/.vnc

# Set VNC password (replace 'YourSecurePasswordHere' with your desired password)
RUN echo 'YourSecurePasswordHere' | vncpasswd -f > /root/.vnc/passwd && \
    chmod 600 /root/.vnc/passwd

# Create the startup script
RUN echo '#!/bin/sh\n\
export DISPLAY=:1\n\
# Generate .Xauthority file\n\
xauth generate $DISPLAY . trusted\n\
# Start Xvnc server\n\
Xvnc $DISPLAY -geometry 1280x800 -depth 24 -SecurityTypes VncAuth -PasswordFile /root/.vnc/passwd &\n\
sleep 2\n\
# Start Openbox\n\
openbox-session &\n\
# Start Firefox\n\
firefox &\n\
wait' > /root/startup.sh && \
    chmod +x /root/startup.sh

# Expose the VNC port
EXPOSE 5901

# Set the default command to run the startup script
CMD ["/root/startup.sh"]
